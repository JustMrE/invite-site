<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–°–ø–∏—Å–æ–∫ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .guest-input {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: grab;
      }
      .guest-input .drag-handle {
        cursor: grab;
        user-select: none;
      }
      @media (max-width: 576px) {
        td,
        th {
          font-size: 0.875rem;
        }
        .btn-sm {
          font-size: 0.75rem;
          padding: 0.25rem 0.5rem;
        }
        .form-select {
          font-size: 0.875rem;
        }
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark px-3">
      <a class="navbar-brand" href="#">–ü—Ä–∏–≥–ª–∞—Å–∏—Ç–µ–ª—å–Ω—ã–µ</a>
      <button
        class="navbar-toggler"
        type="button"
        data-bs-toggle="collapse"
        data-bs-target="#navbarNav"
        aria-controls="navbarNav"
        aria-expanded="false"
        aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞–≤–∏–≥–∞—Ü–∏—é"
      >
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-3">
          <li class="nav-item">
            <a class="nav-link" href="create.html">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="guests.html">–°–ø–∏—Å–æ–∫ –≥–æ—Å—Ç–µ–π</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="invites.html"
              >–°–ø–∏—Å–æ–∫ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π</a
            >
          </li>
        </ul>
      </div>
    </nav>

    <main class="container mt-4">
      <h2>üì® –°–ø–∏—Å–æ–∫ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π</h2>
      <div class="mb-3">
        <label>–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ:</label>
        <select id="sortSelect" class="form-select w-auto d-inline-block ms-2">
          <option value="created">–î–∞—Ç–µ</option>
          <option value="id">ID</option>
          <option value="guests">–ì–æ—Å—Ç—è–º</option>
        </select>
      </div>
      <div class="table-responsive">
        <table class="table table-striped">
          <thead>
            <tr>
              <th>–î–∞—Ç–∞</th>
              <th>ID</th>
              <th>–ì–æ—Å—Ç–∏</th>
              <th>–°—Å—ã–ª–∫–∞</th>
              <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
            </tr>
          </thead>
          <tbody id="invitesTableBody"></tbody>
        </table>
      </div>
    </main>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="–ó–∞–∫—Ä—ã—Ç—å"
            ></button>
          </div>
          <div class="modal-body">
            <p><strong>ID:</strong> <span id="modalInviteId"></span></p>
            <div class="mb-2"><strong>–ì–æ—Å—Ç–∏:</strong></div>
            <div id="guestInputsContainer" class="mb-3"></div>
            <button id="addGuestBtn" class="btn btn-secondary btn-sm mb-3">
              –î–æ–±–∞–≤–∏—Ç—å –≥–æ—Å—Ç—è
            </button>
            <div class="d-flex justify-content-end">
              <button id="saveInviteBtn" class="btn btn-success me-2">
                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
              </button>
              <button id="deleteInviteBtn" class="btn btn-danger">
                –£–¥–∞–ª–∏—Ç—å
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyAXb5k4WAUbXI3zlXt-J0jPprO837zr8v8",
        authDomain: "toiinvite2025.firebaseapp.com",
        databaseURL: "https://toiinvite2025-default-rtdb.firebaseio.com",
        projectId: "toiinvite2025",
        storageBucket: "toiinvite2025.appspot.com",
        messagingSenderId: "228773799390",
        appId: "1:228773799390:web:2ae10163590ff87e1c294f",
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();

      const tableBody = document.getElementById("invitesTableBody");
      const sortSelect = document.getElementById("sortSelect");
      const modal = new bootstrap.Modal(document.getElementById("editModal"));
      const modalInviteId = document.getElementById("modalInviteId");
      const guestInputsContainer = document.getElementById(
        "guestInputsContainer"
      );
      const deleteInviteBtn = document.getElementById("deleteInviteBtn");
      const saveInviteBtn = document.getElementById("saveInviteBtn");
      const addGuestBtn = document.getElementById("addGuestBtn");

      let currentInviteId = null;
      let currentRow = null;
      let allInvites = [];

      function renderGuestsInputs(guests = []) {
        guestInputsContainer.innerHTML = "";
        guests.forEach((name) => addGuestInput(name));
      }

      function addGuestInput(name = "") {
        const div = document.createElement("div");
        div.className = "input-group mb-2 guest-input";
        div.innerHTML = `
          <span class="input-group-text drag-handle">‚ò∞</span>
          <input type="text" class="form-control" value="${name}" />
          <button class="btn btn-outline-danger" type="button">‚úï</button>
        `;
        div.querySelector("button").onclick = () => div.remove();
        guestInputsContainer.appendChild(div);
      }

      addGuestBtn.onclick = () => addGuestInput();

      new Sortable(guestInputsContainer, {
        handle: ".drag-handle",
        animation: 150,
      });

      function openEditModal(id, data, row) {
        currentInviteId = id;
        currentRow = row;
        modalInviteId.textContent = id;
        renderGuestsInputs(data.guests || []);
        modal.show();
      }

      deleteInviteBtn.onclick = () => {
        if (!currentInviteId) return;
        if (confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ?")) {
          db.ref(`invites/${currentInviteId}`)
            .remove()
            .then(() => {
              modal.hide();
              if (currentRow) currentRow.remove();
            })
            .catch((err) => alert("–û—à–∏–±–∫–∞: " + err.message));
        }
      };

      saveInviteBtn.onclick = () => {
        const updatedGuests = Array.from(
          guestInputsContainer.querySelectorAll("input")
        )
          .map((input) => input.value.trim())
          .filter((name) => name !== "");

        db.ref(`invites/${currentInviteId}/guests`)
          .set(updatedGuests)
          .then(() => {
            const guestText = updatedGuests.join(", ");
            currentRow.children[2].textContent = guestText || "‚Äî";
            modal.hide();
          })
          .catch((err) => alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: " + err.message));
      };

      function renderTable(invitesObj) {
        tableBody.innerHTML = "";
        const sorted = Object.entries(invitesObj).sort((a, b) => {
          const [ida, aData] = a;
          const [idb, bData] = b;
          const field = sortSelect.value;
          if (field === "created")
            return (bData.created || 0) - (aData.created || 0);
          if (field === "id") return ida.localeCompare(idb);
          if (field === "guests")
            return (aData.guests?.join() || "").localeCompare(
              bData.guests?.join() || ""
            );
          return 0;
        });

        for (const [id, data] of sorted) {
          const guests = (data.guests || []).join(", ");
          const link =
            data.guests && data.guests.length > 0
              ? `${location.origin}/invite-site/index.html?invite=${id}`
              : `${location.origin}/invite-site/index.html`;

          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${new Date(data.created).toLocaleString()}</td>
            <td>${id}</td>
            <td>${guests || "‚Äî"}</td>
            <td>
              <a href="${link}" target="_blank">–û—Ç–∫—Ä—ã—Ç—å</a>
              <button class="btn btn-sm btn-outline-secondary ms-2" onclick="navigator.share ? navigator.share({ title: '–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ', url: '${link}' }) : alert('–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞')">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
            </td>
            <td><button class="btn btn-outline-primary btn-sm">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button></td>
          `;
          row.querySelector(".btn-outline-primary").onclick = () =>
            openEditModal(id, data, row);
          tableBody.appendChild(row);
        }
      }

      db.ref("invites")
        .once("value")
        .then((snapshot) => {
          const invites = snapshot.val() || {};
          allInvites = invites;
          renderTable(invites);
        });

      sortSelect.onchange = () => renderTable(allInvites);
    </script>
  </body>
</html>
