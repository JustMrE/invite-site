<!DOCTYPE html>
<html lang="kk">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Тойға шақыру</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="./css/style.css" />
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  </head>
  <body onload="launchConfetti()">
    <div class="falling-stars" id="fallingStars"></div>
    <div class="balloon-container" id="balloonContainer"></div>
    <div class="lang-toggle">
      <button class="btn btn-outline-secondary" onclick="toggleLang()">
        Қазақша / Русский
      </button>
    </div>

    <header>
      <h1 id="mainTitle">Тойға шақыру</h1>
    </header>

    <section class="section" id="eventDescription">
      <div class="rainbow-overlay">
        <svg
          class="rainbow-svg"
          viewBox="0 0 600 300"
          xmlns="http://www.w3.org/2000/svg"
        >
          <defs>
            <radialGradient id="cloudGradient" cx="50%" cy="50%" r="50%">
              <stop offset="0%" stop-color="#ffffff" />
              <stop offset="100%" stop-color="#e0e0e0" />
            </radialGradient>
          </defs>

          <g class="rainbow-group">
            <path class="arc arc1" d="M100,250 A200,200 0 0,1 500,250" />
            <path class="arc arc2" d="M110,250 A190,190 0 0,1 490,250" />
            <path class="arc arc3" d="M120,250 A180,180 0 0,1 480,250" />
            <path class="arc arc4" d="M130,250 A170,170 0 0,1 470,250" />
            <path class="arc arc5" d="M140,250 A160,160 0 0,1 460,250" />
            <path class="arc arc6" d="M150,250 A150,150 0 0,1 450,250" />
            <path class="arc arc7" d="M160,250 A140,140 0 0,1 440,250" />
          </g>

          <g class="cloudShape">
            <ellipse cx="110" cy="250" rx="40" ry="25" />
            <ellipse cx="130" cy="240" rx="35" ry="20" />
            <ellipse cx="150" cy="255" rx="45" ry="25" />
          </g>
          <g class="cloudShape">
            <ellipse cx="490" cy="250" rx="40" ry="25" />
            <ellipse cx="470" cy="240" rx="35" ry="20" />
            <ellipse cx="450" cy="255" rx="45" ry="25" />
          </g>
        </svg>
      </div>

      <h2 id="guestGreeting">Құрметті қонақтар!</h2>
      <p>Сіздерді біздің қуанышымызға ортақтасуға шақырамыз:</p>
      <ul>
        <li>Қызымыздың 7 жасқа толып, мектепке баруы — Тілашар</li>
        <li>Ұлымыздың сүндетке отырғызуы</li>
        <li>Кішкентай ханшайымымыздың дүниеге келуі — Бесік той</li>
      </ul>
      <p><strong>Той иелері:</strong> Бауржан, Қамар</p>
    </section>

    <section class="section">
      <div id="eventDetails">
        <h2>Кездесу орны мен уақыты</h2>
        <p><strong>15 маусым 2025, 14:00</strong></p>
        <p>Ресторан "Алтын Ел", пр. Дулати 55</p>
      </div>

      <!-- Кнопка/ссылка с иконкой -->
      <div class="mb-3 text-center">
        <a
          href="https://2gis.kz/almaty/firm/70000001025292888"
          target="_blank"
          class="btn btn-outline-success d-inline-flex align-items-center"
          style="gap: 0.5rem"
        >
          <img
            src="https://upload.wikimedia.org/wikipedia/ru/7/77/%D0%9B%D0%BE%D0%B3%D0%BE%D1%82%D0%B8%D0%BF_2%D0%93%D0%98%D0%A1.svg"
            alt="2GIS"
            width="60"
            height="24"
          />
          Открыть в 2ГИС
        </a>
      </div>

      <!-- Стандартные ссылки -->
      <a
        class="dg-widget-link"
        href="http://2gis.kz/almaty/firm/70000001025292888/center/76.89173340797426,43.16542782353295/zoom/17?utm_medium=widget-source&utm_campaign=firmsonmap&utm_source=bigMap"
      >
        Посмотреть на карте Алматы
      </a>
      <div class="dg-widget-link">
        <a
          href="http://2gis.kz/almaty/firm/70000001025292888/photos/70000001025292888/center/76.89173340797426,43.16542782353295/zoom/17?utm_medium=widget-source&utm_campaign=firmsonmap&utm_source=photos"
        >
          Фотографии компании
        </a>
      </div>
      <div class="dg-widget-link">
        <a
          href="http://2gis.kz/almaty/center/76.891566,43.165175/zoom/17/routeTab/rsType/bus/to/76.891566,43.165175╎Алтын Ел, ресторанный комплекс?utm_medium=widget-source&utm_campaign=firmsonmap&utm_source=route"
        >
          Найти проезд до Алтын Ел, ресторанный комплекс
        </a>
      </div>

      <!-- Встраиваемый виджет -->
      <script
        charset="utf-8"
        src="https://widgets.2gis.com/js/DGWidgetLoader.js"
      ></script>
      <script charset="utf-8">
        new DGWidgetLoader({
          width: "100%",
          height: 300,
          borderColor: "#a3a3a3",
          pos: { lat: 43.16542782353295, lon: 76.89173340797426, zoom: 17 },
          opt: { city: "almaty" },
          org: [{ id: "70000001025292888" }],
        });
      </script>
      <noscript style="color: #c00; font-size: 16px; font-weight: bold">
        Виджет карты использует JavaScript. Включите его в настройках вашего
        браузера.
      </noscript>
    </section>

    <section class="section" id="rsvp">
      <h2 id="submitCome">Қатысатыныңызды растаңыз</h2>
      <form id="rsvpForm" class="needs-validation" novalidate>
        <div class="mb-3" id="nameBlock">
          <label class="form-label">Сіздің атыңыз:</label>
          <input type="text" class="form-control" id="guestName" required />
        </div>
        <button type="submit" class="btn btn-success">Қатысамын</button>
        <button
          type="button"
          class="btn btn-outline-secondary ms-2"
          onclick="denyAttendance()"
        >
          Қатыспаймын
        </button>
      </form>
      <p id="thanksMsg" class="mt-3 text-success fw-bold" style="display: none">
        Рақмет, күтеміз!
      </p>
      <p id="sorryMsg" class="mt-3 text-danger fw-bold" style="display: none">
        Қап, өкінішті. Келесі жолы!
      </p>
    </section>

    <section class="section" id="countdown">
      <h2>Қалған уақыт</h2>
      <div class="countdown-wrapper">
        <div class="time-box">
          <span id="days">00</span>
          <small>күн</small>
        </div>
        <div class="time-box">
          <span id="hours">00</span>
          <small>сағат</small>
        </div>
        <div class="time-box">
          <span id="minutes">00</span>
          <small>минут</small>
        </div>
        <div class="time-box">
          <span id="seconds">00</span>
          <small>секунд</small>
        </div>
      </div>
    </section>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyAXb5k4WAUbXI3zlXt-J0jPprO837zr8v8",
        authDomain: "toiinvite2025.firebaseapp.com",
        databaseURL: "https://toiinvite2025-default-rtdb.firebaseio.com",
        projectId: "toiinvite2025",
        storageBucket: "toiinvite2025.appspot.com",
        messagingSenderId: "228773799390",
        appId: "1:228773799390:web:2ae10163590ff87e1c294f",
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const params = new URLSearchParams(location.search);
        const inviteId =
          params.get("invite") ?? Math.random().toString(36).substr(2, 9);
        const isNamed = !!inviteId;

        const guestNameInput = document.getElementById("guestName");
        const nameBlock = document.getElementById("nameBlock");
        const form = document.getElementById("rsvpForm");
        const thanksMsg = document.getElementById("thanksMsg");
        const sorryMsg = document.getElementById("sorryMsg");
        const greeting = document.getElementById("guestGreeting");
        const submitCome = document.getElementById("submitCome");

        if (isNamed) {
          firebase
            .database()
            .ref("invites/" + inviteId)
            .once("value")
            .then((snapshot) => {
              const data = snapshot.val();
              if (
                data &&
                Array.isArray(data.guests) &&
                data.guests.length > 0
              ) {
                const namesText = data.guests.join(", ");
                greeting.innerText = `Құрметті ${namesText}!`;
                submitCome.innerText = `Құрметті ${namesText}! Қатысатыныңызды растаңыз.`;
                nameBlock.style.display = "none";
              }
            });
        }

        form.addEventListener("submit", function (e) {
          e.preventDefault();
          sendRSVP("yes");
        });

        window.denyAttendance = function (e) {
          sendRSVP("no");
        };

        function sendRSVP(status) {
          const name = isNamed ? "" : guestNameInput.value.trim();

          if (!isNamed && name === "") {
            alert("Атыңызды енгізіңіз");
            return;
          } else {
            const updateData = {
              status,
              respondedAt: new Date().toISOString(),
            };

            if (!isNamed && name !== "") {
              updateData.guests = firebase.database.ServerValue.arrayUnion
                ? firebase.database.ServerValue.arrayUnion(name)
                : [name]; // Fallback для совместимости
            }

            firebase
              .database()
              .ref("invites/" + inviteId)
              .update(updateData)
              .then(() => {
                form.style.display = "none";
                if (status === "yes") {
                  thanksMsg.style.display = "block";
                } else {
                  sorryMsg.style.display = "block";
                }
              });
          }
        }
      });
    </script>
    <script src="./js/script.js"></script>
  </body>
</html>
